{% extends 'base.html' %}
{% load static %}

{% block head_extra %}
  {# CodeMirror CSS #}
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/theme/dracula.min.css"
  />
  <style>
    .CodeMirror {
      border: 1px solid #555;
      border-radius: 4px;
      min-height: 200px;
    }
    /* –°–∫—Ä—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ textarea */
    #htmlCode,
    #jsCode {
      display: none !important;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container my-8">
  <h2 class="text-3xl text-cyan-400 font-semibold mb-4">üîß {{ module.title }}</h2>
  <p class="text-slate-300 mb-8">{{ module.description }}</p>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- HTML -->
    <div class="flex flex-col">
      <label class="text-white mb-2 font-medium">HTML-–∫–æ–¥:</label>
      <textarea id="htmlCode"><div id="output">Hello</div></textarea>
      <div id="htmlEditor"></div>
    </div>
    <!-- JS -->
    <div class="flex flex-col">
      <label class="text-white mb-2 font-medium">JS-–∫–æ–¥:</label>
      <textarea id="jsCode">// –≤–∞—à JS —Ç—É—Ç</textarea>
      <div id="jsEditor"></div>
    </div>
  </div>

  <button id="runBtn"
          class="mt-6 bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded"
  >–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>

  <h3 class="text-white font-semibold mt-8 mb-2">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
  <iframe
    id="preview"
    sandbox="allow-scripts allow-same-origin"
    class="w-full h-56 bg-white border rounded"
  ></iframe>

  <div id="feedback" class="mt-4 text-lg font-medium"></div>
</div>
{% endblock %}

{% block extra_js %}
  <script>
    // –û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥ –∏–∑ –ë–î –∏–ª–∏ null
    window.expectedOutput = {{ module.expected_output|default:"null"|escapejs }};
  </script>

  {# –ü–æ–¥–∫–ª—é—á–∞–µ–º CodeMirror #}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.12/addon/edit/closetag.min.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã
    const htmlArea = document.getElementById('htmlCode');
    const jsArea   = document.getElementById('jsCode');
    window.htmlEditor = CodeMirror(
      document.getElementById('htmlEditor'),
      {
        value: htmlArea.value.trim(),
        mode: 'xml',
        htmlMode: true,
        theme: 'dracula',
        lineNumbers: true,
        autoCloseTags: true,
      }
    );
    window.jsEditor = CodeMirror(
      document.getElementById('jsEditor'),
      {
        value: jsArea.value.trim(),
        mode: 'javascript',
        theme: 'dracula',
        lineNumbers: true,
      }
    );

    const btn     = document.getElementById('runBtn');
    const preview = document.getElementById('preview');
    const fb      = document.getElementById('feedback');

    // –ü–æ–º–æ—â–Ω–∏–∫: –≤—ã—Ç—è–≥–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ <div id="output">‚Ä¶</div>
    function extractOutput(html) {
      const m = html.match(/<div[^>]*id=['"]output['"][^>]*>([\s\S]*?)<\/div>/);
      return m ? m[1].trim() : '';
    }

    btn.addEventListener('click', () => {
      fb.textContent = '';
      const userHtml = window.htmlEditor.getValue();
      const userJs   = window.jsEditor.getValue();
      // –í—ã—á–∏—Å–ª—è–µ–º expected: –∏–∑ –ë–î –∏–ª–∏ –∏–∑ HTML
      const expected = window.expectedOutput != null
        ? String(window.expectedOutput).trim()
        : extractOutput(userHtml);

      // 2) –ù–∞–≤–µ—à–∏–≤–∞–µ–º onload-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–µ–¥ srcdoc
      const onLoadHandler = () => {
        const doc = preview.contentDocument;
        if (!doc) return;
        // –ò–Ω–∂–µ–∫—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π JS
        const s1 = doc.createElement('script');
        s1.textContent = userJs;
        doc.body.appendChild(s1);
        // –ò–Ω–∂–µ–∫—Ç–∏–º —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
        const s2 = doc.createElement('script');
        s2.textContent = `
          (function(){
            const out = (document.getElementById('output')?.innerText||'').trim();
            parent.postMessage(out, '*');
          })();
        `;
        doc.body.appendChild(s2);
        // –°–Ω–∏–º–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–æ–ø–∏—Ç—å –µ–≥–æ
        preview.removeEventListener('load', onLoadHandler);
      };
      preview.addEventListener('load', onLoadHandler);

      // 3) –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∏—Å—Ç—ã–π HTML
      preview.srcdoc = `
        <html><head><meta charset="utf-8"></head>
        <body>${userHtml}</body>
        </html>
      `;
    });

    // 4) –õ–æ–≤–∏–º –æ—Ç–≤–µ—Ç –∏–∑ iframe –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º
    window.addEventListener('message', e => {
      const got = (e.data||'').trim();
      const userHtml = window.htmlEditor.getValue();
      const expected = window.expectedOutput != null
        ? String(window.expectedOutput).trim()
        : extractOutput(userHtml);
      fb.innerHTML = got === expected
        ? '<span class="text-green-400">‚úÖ –í–µ—Ä–Ω–æ!</span>'
        : `<span class="text-red-400">‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –û–∂–∏–¥–∞–ª–æ—Å—å: ‚Äú${expected}‚Äù, –ø–æ–ª—É—á–µ–Ω–æ: ‚Äú${got}‚Äù</span>`;
    });
  });
  </script>
{% endblock %}
